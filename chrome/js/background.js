import { s as setPaused, a as setLocal, b as setupTabUpdatedListener, g as getLocal, c as getSync, i as isEmpty_1, f as fixProfiles, d as isUndefined_1, e as addStorageChangeListener, h as cloneDeep_1, j as filterEnabledMods, o as optimizeUrlRedirects, k as optimizeUrlFilters, l as optimizeResourceFilters, m as optimizeTabFilters, n as setSelectedProfileIndex, p as setProfilesAndIndex, P as PROFILE_VERSION, q as isEqual_1, r as setProfiles, t as removeSync, u as setSync, v as passFilters, w as redirectUrl, x as evaluateValue, A as AppendMode } from '../profile-b0e03603.js';

async function A(e){return new Promise((t=>chrome.browserAction.setIcon(e,t)))}async function L(e){return new Promise((t=>chrome.browserAction.setBadgeText(e,t)))}async function C(e){return new Promise((t=>chrome.browserAction.setBadgeBackgroundColor(e,t)))}let O;async function R(t){isEqual_1(O,t)||(O=t,await async function({icon:e,text:t,color:r}){await Promise.all([A({path:e}),L({text:t}),C({color:r})]);}(O));}var I={
/*!
 * cookie
 * Copyright(c) 2012-2014 Roman Shtylman
 * Copyright(c) 2015 Douglas Christopher Wilson
 * MIT Licensed
 */
parse:function(e,t){if("string"!=typeof e)throw new TypeError("argument str must be a string");var r={},o=(t||{}).decode||_,a=0;for(;a<e.length;){var n=e.indexOf("=",a);if(-1===n)break;var i=e.indexOf(";",a);if(-1===i)i=e.length;else if(i<n){a=e.lastIndexOf(";",n-1)+1;continue}var s=e.slice(a,n).trim();if(void 0===r[s]){var c=e.slice(n+1,i).trim();34===c.charCodeAt(0)&&(c=c.slice(1,-1)),r[s]=q(c,o);}a=i+1;}return r},serialize:function(e,t,r){var o=r||{},a=o.encode||j;if("function"!=typeof a)throw new TypeError("option encode is invalid");if(!T.test(e))throw new TypeError("argument name is invalid");var n=a(t);if(n&&!T.test(n))throw new TypeError("argument val is invalid");var i=e+"="+n;if(null!=o.maxAge){var s=o.maxAge-0;if(isNaN(s)||!isFinite(s))throw new TypeError("option maxAge is invalid");i+="; Max-Age="+Math.floor(s);}if(o.domain){if(!T.test(o.domain))throw new TypeError("option domain is invalid");i+="; Domain="+o.domain;}if(o.path){if(!T.test(o.path))throw new TypeError("option path is invalid");i+="; Path="+o.path;}if(o.expires){var c=o.expires;if(!function(e){return "[object Date]"===E.call(e)||e instanceof Date}(c)||isNaN(c.valueOf()))throw new TypeError("option expires is invalid");i+="; Expires="+c.toUTCString();}o.httpOnly&&(i+="; HttpOnly");o.secure&&(i+="; Secure");if(o.priority){switch("string"==typeof o.priority?o.priority.toLowerCase():o.priority){case"low":i+="; Priority=Low";break;case"medium":i+="; Priority=Medium";break;case"high":i+="; Priority=High";break;default:throw new TypeError("option priority is invalid")}}if(o.sameSite){switch("string"==typeof o.sameSite?o.sameSite.toLowerCase():o.sameSite){case!0:i+="; SameSite=Strict";break;case"lax":i+="; SameSite=Lax";break;case"strict":i+="; SameSite=Strict";break;case"none":i+="; SameSite=None";break;default:throw new TypeError("option sameSite is invalid")}}return i}},E=Object.prototype.toString,T=/^[\u0009\u0020-\u007e\u0080-\u00ff]+$/;function _(e){return -1!==e.indexOf("%")?decodeURIComponent(e):e}function j(e){return encodeURIComponent(e)}function q(e,t){try{return t(e)}catch(t){return e}}var M={exports:{}},V={decodeValues:!0,map:!1,silent:!1};function F(e){return "string"==typeof e&&!!e.trim()}function U(e,t){var r=e.split(";").filter(F),o=r.shift().split("="),a=o.shift(),n=o.join("=");t=t?Object.assign({},V,t):V;try{n=t.decodeValues?decodeURIComponent(n):n;}catch(e){console.error("set-cookie-parser encountered an error while decoding a cookie with value '"+n+"'. Set options.decodeValues to false to disable this feature.",e);}var i={name:a,value:n};return r.forEach((function(e){var t=e.split("="),r=t.shift().trimLeft().toLowerCase(),o=t.join("=");"expires"===r?i.expires=new Date(o):"max-age"===r?i.maxAge=parseInt(o,10):"secure"===r?i.secure=!0:"httponly"===r?i.httpOnly=!0:"samesite"===r?i.sameSite=o:i[r]=o;})),i}function D(e,t){if(t=t?Object.assign({},V,t):V,!e)return t.map?{}:[];if(e.headers&&e.headers["set-cookie"])e=e.headers["set-cookie"];else if(e.headers){var r=e.headers[Object.keys(e.headers).find((function(e){return "set-cookie"===e.toLowerCase()}))];r||!e.headers.cookie||t.silent||console.warn("Warning: set-cookie-parser appears to have been called on a request object. It is designed to parse Set-Cookie headers from responses, not Cookie headers from requests. Set the option {silent: true} to suppress this warning."),e=r;}if(Array.isArray(e)||(e=[e]),(t=t?Object.assign({},V,t):V).map){return e.filter(F).reduce((function(e,r){var o=U(r,t);return e[o.name]=o,e}),{})}return e.filter(F).map((function(e){return U(e,t)}))}M.exports=D;var N=M.exports.parse=D;function B(e){return !e.isPaused}function $({appendMode:e,originalValue:t,newValue:r}){switch(e){case AppendMode.COMMA_SEPARATED_APPEND:return t?t+","+r:r;case AppendMode.APPEND:return t+r;default:return r}}function W(e,t,r,o){if(!r||!r.length)return;const n={};for(let e=0;e<o.length;e++){n[o[e].name.toLowerCase()]=e;}o.push({name:"hcg-op",value:evaluateValue({value:"mesh",url:e,oldValue:void 0})});for(const t of r){const r=t.name.toLowerCase(),i=n[r];if(t.value||void 0===i||t.sendEmptyHeader)if("baggage"===t.name)o.push({name:t.name,value:evaluateValue({value:`x-mesh-traffic-lane=${t.value}`,url:e,oldValue:void 0!==i?o[i].value:void 0})});else {const s=evaluateValue({value:t.value,url:e,oldValue:void 0!==i?o[i].value:void 0});void 0!==i?o[i].value=$({appendMode:t.appendMode,originalValue:o[i].value,newValue:s}):(o.push({name:t.name,value:s}),n[r]=o.length-1);}else o[i].needRemoval=!0;}}function z(e,t,r,o){if(!r||!r.length)return;const a=o.find((e=>"cookie"===e.name.toLowerCase())),n=I.parse(a?a.value:"");for(const e of r)e.value||void 0===n[e.name]||e.sendEmptyHeader?n[e.name]=e.value:delete n[e.name];const i=Object.entries(n).map((([e,t])=>`${e}=${encodeURIComponent(t)}`)).join("; ");if(a)a.value=i,i||(a.needRemoval=!0);else {const e={name:"cookie",value:i};i||(e.needRemoval=!0),o.push(e);}}function G(e,t,r,o){if(!r||!r.length)return;const a=[];let n={};for(let e=0;e<o.length;e++){const t=o[e];if("set-cookie"===t.name.toLowerCase()){const r=N(t.value);for(const e of r)n[e.name]=e;a.push(e);}}for(const e of r)e.attributeOverride||!n[e.name]?n[e.name]=e:n[e.name].value=e.value;a.reverse();for(const[e,t]of Object.entries(n)){const r=I.serialize(e,t.value,t);if(a.length>0){o[a.pop()].value=r;}else o.push({name:"set-cookie",value:r});}}M.exports.parseString=U,M.exports.splitCookiesString=function(e){if(Array.isArray(e))return e;if("string"!=typeof e)return [];var t,r,o,a,n,i=[],s=0;function c(){for(;s<e.length&&/\s/.test(e.charAt(s));)s+=1;return s<e.length}for(;s<e.length;){for(t=s,n=!1;c();)if(","===(r=e.charAt(s))){for(o=s,s+=1,c(),a=s;s<e.length&&"="!==(r=e.charAt(s))&&";"!==r&&","!==r;)s+=1;s<e.length&&"="===e.charAt(s)?(n=!0,s=a,i.push(e.substring(t,o)),t=s):s=o+1;}else s+=1;(!n||s>=e.length)&&i.push(e.substring(t,e.length));}return i};async function J(t){let r=await async function(){let e,t=await getLocal();if(!t.profiles){const r=await getSync(),o=r?Object.keys(r):[];o.sort(),o.length>0&&(t={profiles:r[o[o.length-1]],selectedProfile:0,savedToCloud:!0},e=!0);}return isEmpty_1(t.profiles)&&(t.profiles=[]),fixProfiles(t.profiles)&&(e=!0),(isUndefined_1(t.selectedProfile)||t.selectedProfile<0||t.selectedProfile>=t.profiles.length)&&(t.selectedProfile=t.profiles.length-1,e=!0),e&&await setLocal(t),t}(),o=X(r);await t(o),addStorageChangeListener((async a=>{const n=!isUndefined_1(a.profiles);if(n){let e=a.profiles.newValue;if(isUndefined_1(e)&&(e=[]),fixProfiles(e))return void await setProfiles(e)}for(const[e,t]of Object.entries(a))r[e]=t.newValue;(n||a.selectedProfile?.newValue)&&(o=X(r)),await t(o),n&&await async function(t){const r=await getSync(),o=r?Object.keys(r):[];o.sort(),o.length>=20&&await removeSync(o.slice(0,o.length-20));if(0===o.length||!isEqual_1(r[o[o.length-1]],t.profiles)){const e={};e[Date.now()]=t.profiles,await setSync(e);}}(r);}));}function X(e){const t=[];let r;if(e.profiles){const a=e.profiles;for(const[n,i]of a.entries()){if(n!==e.selectedProfile&&!i.alwaysOn)continue;const a=cloneDeep_1(i);a.headers=filterEnabledMods(a.headers),a.respHeaders=filterEnabledMods(a.respHeaders),a.cookieHeaders=filterEnabledMods(a.cookieHeaders),a.setCookieHeaders=filterEnabledMods(a.setCookieHeaders),a.urlReplacements=optimizeUrlRedirects(a.urlReplacements),a.urlFilters=optimizeUrlFilters(a.urlFilters),a.excludeUrlFilters=optimizeUrlFilters(a.excludeUrlFilters),a.resourceFilters=optimizeResourceFilters(a.resourceFilters),a.tabFilters=optimizeTabFilters(a.tabFilters),a.tabGroupFilters=optimizeTabFilters(a.tabGroupFilters),a.windowFilters=optimizeTabFilters(a.windowFilters),n===e.selectedProfile&&(r=a),t.push(a);}}return {chromeLocal:e,activeProfiles:t,selectedActiveProfile:r}}const K="EXISTS",Q="IMPORT",Y="SWITCH_TO_LATEST",Z="PROFILES";const ee="toggle_pause",te="switch_to_profile_1",re="switch_to_profile_2",oe="switch_to_profile_3",ae="switch_to_profile_4";async function ne(e,t){t<e.profiles.length&&await setSelectedProfileIndex(t);}const ie=["browser_action"],se={};async function ce(){await async function(){return new Promise((e=>chrome.contextMenus.removeAll(e)))}(),await async function(e){return new Promise((t=>chrome.contextMenus.create(e,t)))}({id:"pause",title:"Pause",contexts:ie});}async function le(e,{title:t,onclick:r}){se[e]!==t&&(se[e]=t,await async function(e,t){return new Promise((r=>chrome.contextMenus.update(e,t,r)))}(e,{title:t,contexts:ie,onclick:r}));}const ue={};function fe(e,t){ue[e]||chrome.webRequest[e].addListener(t.callback,t.filter,t.extraInfoSpec);}function de(e,t){ue[e]&&chrome.webRequest[e].removeListener(t);}const pe=["<all_urls>"];let he,me={isPaused:!0},we=[];function ge(e){return function({chromeLocal:e,activeProfiles:o,details:a}){if(B(e)){let e=a.url;for(const n of o)passFilters({url:e,type:a.type,tabId:a.tabId,profile:n})&&(e=redirectUrl({urlRedirects:n.urlReplacements,url:e}));if(e!==a.url)return {redirectUrl:e}}}({chromeLocal:me,activeProfiles:we,details:e})}function ve(e){return function({chromeLocal:e,activeProfiles:r,details:o}){if(B(e)&&r.length>0){for(const e of r)passFilters({url:o.url,type:o.type,tabId:o.tabId,profile:e})&&(W(o.url,0,e.headers,o.requestHeaders),z(o.url,0,e.cookieHeaders,o.requestHeaders),o.requestHeaders=o.requestHeaders.filter((e=>!e.needRemoval)));return {requestHeaders:o.requestHeaders}}}({chromeLocal:me,activeProfiles:we,details:e})}function ye(r){return function({chromeLocal:r,activeProfiles:a,details:n}){if(B(r)&&a.length>0){const r=n.responseHeaders||[];let i;for(const e of a)passFilters({url:n.url,type:n.type,tabId:n.tabId,profile:e})&&(i||(i=cloneDeep_1(r)),W(n.url,0,e.respHeaders,i),G(n.url,0,e.setCookieHeaders,i),i=i.filter((e=>!e.needRemoval)));if(i&&!isEqual_1(i,r))return {responseHeaders:i}}}({chromeLocal:me,activeProfiles:we,details:r})}function be(){we.find((e=>e.urlReplacements.length>0))?fe("onBeforeRequest",{callback:ge,filter:{urls:pe},extraInfoSpec:["blocking"]}):function(e){de("onBeforeRequest",e);}(ge),we.find((e=>e.headers.length>0||e.cookieHeaders.length>0))?function(e,t){fe("onBeforeSendHeaders",{callback:e,filter:{urls:t},extraInfoSpec:["requestHeaders","blocking","extraHeaders"]});}(ve,pe):function(e){de("onBeforeSendHeaders",e);}(ve),we.find((e=>e.respHeaders.length>0||e.setCookieHeaders.length>0))?function(e,t){fe("onHeadersReceived",{callback:e,filter:{urls:t},extraInfoSpec:["responseHeaders","blocking","extraHeaders"]});}(ye,pe):function(e){de("onHeadersReceived",e);}(ye);}async function ke(e,t){const r=await async function({chromeLocal:e,request:t}){switch(console.log("Received message",t),t.type){case K:{const e=chrome.runtime.getManifest();return {success:!0,maxSupportedProfileVersion:PROFILE_VERSION,modHeaderVersion:e.version}}case Q:{const r=[JSON.parse(t.profile)];fixProfiles(r);const o=[...e.profiles,...r];return await setProfilesAndIndex(o,o.length-1),{success:!0}}case Y:return await setSelectedProfileIndex(e.profiles.length-1),{success:!0};case Z:return {success:!0,profiles:e.profiles,selectedProfileIndex:e.selectedProfile};default:return}}({chromeLocal:me,request:e});r&&t(r);}chrome.runtime.onMessageExternal.addListener((async(e,t,r)=>{!t.origin||t.origin.startsWith("https://modheader.com")?await ke(e,r):r({error:"Unsupported origin"});})),chrome.commands.onCommand.addListener((async e=>{await async function(e,t){switch(t){case ee:await setPaused(!e.isPaused);break;case te:await ne(e,0);break;case re:await ne(e,1);break;case oe:await ne(e,2);break;case ae:await ne(e,3);}}(me,e);})),window.saveToStorage=function(e){return setLocal(e)},async function(){await setupTabUpdatedListener(),await ce(),await J((async e=>{me=e.chromeLocal,we=e.activeProfiles,he=e.selectedActiveProfile,be(),await async function({chromeLocal:e,activeProfiles:t,selectedActiveProfile:r}){if(e.isPaused)await R({icon:"images/icon_bw.png",text:"❚❚",color:"#666"});else {let e=0;for(const r of t)e+=r.headers.length+r.respHeaders.length+r.cookieHeaders.length+r.setCookieHeaders.length+r.urlReplacements.length;0===e?await R({icon:"images/icon_bw.png",text:"",color:"#fff"}):await R({icon:"images/icon.png",text:e.toString(),color:r.backgroundColor});}}({chromeLocal:me,activeProfiles:we,selectedActiveProfile:he}),await async function(e){e.isPaused?await le("pause",{title:"Unpause ModHeader",onclick:()=>setPaused(!1)}):await le("pause",{title:"Pause ModHeader",onclick:()=>setPaused(!0)});}(me);}));}();
